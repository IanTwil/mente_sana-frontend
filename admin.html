<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Moderación | MenteSana</title>
    <style>
        body {
            font-family: sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 20px;
        }

        .section-container {
            margin-bottom: 50px;
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: #0f3460;
        }

        th,
        td {
            border: 1px solid #333;
            padding: 12px;
            text-align: left;
        }

        th {
            background: #16a085;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        h2 {
            color: #1abc9c;
            border-bottom: 2px solid #1abc9c;
            padding-bottom: 10px;
        }
    </style>
</head>

<body>

    <h1>Panel de Control Maestro</h1>

    <div class="section-container">
        <h2>Moderación de Comentarios</h2>
        <div id="adminList">Cargando comentarios...</div>
    </div>

    <div class="section-container">
        <h2>Usuarios e Identidades (IDs)</h2>
        <div id="usersList">Cargando base de datos de usuarios...</div>
    </div>

    <script>

        const API_URL = "https://mente-sana-frontend.onrender.com";


        let adminPass = "";

        async function loadData() {

            adminPass = prompt("Ingrese la clave de administrador para acceder al panel:");
            if (!adminPass) {
                document.body.innerHTML = "<h1>Acceso denegado</h1><p>Se requiere clave para ver este panel.</p>";
                return;
            }

            loadComments();
            loadUsers();
        }

        async function loadComments() {
            const container = document.getElementById('adminList');
            try {
                const res = await fetch(`${API_URL}/admin/todo`, {
                    headers: { 'x-admin-key': adminPass } // Enviamos la clave
                });

                if (!res.ok) throw new Error("No autorizado");

                const data = await res.json();

                if (data.length === 0) {
                    container.innerHTML = "<p>No hay comentarios.</p>";
                    return;
                }

                let html = '<table><tr><th>ID</th><th>Lectura</th><th>Autor</th><th>Comentario</th><th>Acción</th></tr>';
                data.forEach(c => {
                    html += `<tr>
                    <td>${c.id}</td>
                    <td>${c.lectura_id}</td>
                    <td>${c.nombre}</td>
                    <td>${c.contenido}</td>
                    <td><button class="btn-delete" onclick="deleteComm(${c.id})">Eliminar</button></td>
                </tr>`;
                });
                container.innerHTML = html + '</table>';
            } catch (e) {
                container.innerHTML = "<p style='color:red;'>Error: Clave incorrecta o servidor apagado.</p>";
            }
        }

        async function loadUsers() {
            const container = document.getElementById('usersList');
            try {
                const res = await fetch(`${API_URL}/admin/usuarios`, {
                    headers: { 'x-admin-key': adminPass } // Enviamos la clave
                });

                if (!res.ok) throw new Error("No autorizado");

                const data = await res.json();

                let html = '<table><tr><th>Nombre Real</th><th>Rol</th><th>ID Asignado (#)</th></tr>';
                data.forEach(u => {
                    html += `<tr>
                    <td>${u.nombre_real}</td>
                    <td>${u.rol}</td>
                    <td>#${u.digitos_id}</td>
                </tr>`;
                });
                container.innerHTML = html + '</table>';
            } catch (e) {
                container.innerHTML = "<p style='color:red;'>No se pudo cargar la lista de usuarios (Clave incorrecta).</p>";
            }
        }

        async function deleteComm(id) {
            const password = prompt("Clave de administrador:");
            if (!password) return;

            if (confirm('¿Borrar comentario?')) {
                try {
                    const response = await fetch(`${API_URL}/comentarios/${id}`, {
                        method: 'DELETE',
                        headers: { 'x-admin-key': password }
                    });
                    if (response.ok) { alert("Eliminado"); loadComments(); }
                    else { alert("Error de clave o servidor"); }
                } catch (error) { alert("Error de conexión"); }
            }
        }

        loadData();
    </script>
</body>

</html>